name: "CI"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  HF_MODEL_REPO: "Supertone/supertonic"

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Download ONNX models from HuggingFace
        run: |
          pip install huggingface_hub
          python -c "
          from huggingface_hub import hf_hub_download
          import os
          
          repo_id = '${{ env.HF_MODEL_REPO }}'
          files = [
              'onnx/duration_predictor.onnx',
              'onnx/text_encoder.onnx',
              'onnx/vector_estimator.onnx',
              'onnx/vocoder.onnx',
              'onnx/unicode_indexer.json',
              'onnx/tts.json',
              'voice_styles/M1.json',
              'voice_styles/M2.json',
              'voice_styles/F1.json',
              'voice_styles/F2.json',
          ]
          
          for f in files:
              local_dir = 'assets'
              os.makedirs(os.path.join(local_dir, os.path.dirname(f)), exist_ok=True)
              hf_hub_download(repo_id=repo_id, filename=f, local_dir=local_dir)
          "

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Build
        run: cargo build --workspace

      - name: Test
        run: cargo test --workspace
